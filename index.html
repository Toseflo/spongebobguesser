<!DOCTYPE html>
<html lang="en">
<head>
    <title>Spongebob Guesser</title>

    <!-- Include Tippy.js library -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away-subtle.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #image-container {
            display: flex;
            width: 100%;
            height: 60vh; /* Adjust this value as needed */
            border: none;
            margin: 0 auto;
            justify-content: center;
            align-items: center;
            background-size: contain; /* This will prevent the image from being stretched */
            background-position: center; /* This will center the image */
            background-repeat: no-repeat; /* This will prevent the image from repeating */
        }

        #image-container img {
            width: 100%; /* This will make the image take up the entire width */
            height: auto;
            object-fit: contain; /* This will prevent the image from being stretched */
        }

        @media (max-aspect-ratio: 3/2) {
            #image-container {
                width: 100%;
                height: auto;
                padding-top: 75%; /* Adjust this value as needed based on the aspect ratio of the image without black bars */
                margin-left: auto;
                margin-right: auto;
                overflow-x: hidden; /* This will prevent horizontal scrolling */
                background-size: cover; /* This will make the image as large as possible while still being contained within the background positioning area */
                background-position: center; /* This will center the image within the positioning area */
            }
        }

        #lives-left,
        #score,
        #high-score {
            text-align: center;
            margin: 10px auto;
            font-size: 1.3em;
            caret-color: transparent;
        }

        #feedback {
            text-align: center;
            margin: 20px auto;
            font-size: 1.3em;
        }

        #no-season-label,
        #guess-input {
            display: block;
            width: 600px;
            margin: 20px auto;
            padding: 10px;
            font-size: 1.3em;
            text-align: center;
        }

        #language-select,
        #season-select {
            display: block;
            width: 210px;
            margin: 10px auto;
            padding: 7px;
            font-size: 1.2em;
        }

        #guess-input,
        #language-select,
        #season-select {
            border-radius: 8px;
        }

        #guess-button,
        #joker-button,
        #try-again-button,
        #continue-button {
            display: block;
            margin: 0 auto;
            padding: 20px 30px;
            font-size: 1.5em;
            border-radius: 8px;
            caret-color: transparent;
        }

        #try-again-button,
        #no-season-label,
        #continue-button {
            display: none;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            caret-color: transparent;
        }

        .select-group label {
            font-size: 1em;
        }

        .container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin: -30px auto;
            width: 80%;
        }

        .column {
            flex: 1;
            text-align: center;
        }

        .center-horizontal {
            display: flex;
            justify-content: center;
            margin: -100px auto;
        }
    </style>
</head>
<body>
<div id="image-container"></div>
<div id="no-season-label">You have to select at least one season</div>
<input id="guess-input" list="episode-names" placeholder="Guess the episode...">
<div id="feedback"></div>
<div class="container">
    <div class="column">
        <div class="select-group">
            <label for="language-select">Language:</label>
            <select id="language-select"></select>
        </div>
        <div class="select-group">
            <label for="season-select">Seasons:</label>
            <select id="season-select" multiple></select>
        </div>
    </div>
    <div class="column">
        <button id="joker-button" onclick="handleJokerClick() ">Joker</button>
    </div>
    <div class="column">
        <button id="guess-button" onclick="checkGuess(document.getElementById('guess-input').value)"><b>Guess</b>
        </button>
    </div>
    <div class="column">
        <div id="lives-left">Lives: 3</div>
        <div id="score">Score: 0</div>
        <div id="high-score">High Score: 0</div>
    </div>
</div>
<div class="center-horizontal">
    <button id="continue-button" onclick="continueGame()">Continue</button>
    <button id="try-again-button" onclick="resetGame()"><b>Try Again</b></button>
</div>

<datalist id="episode-names">
    <!-- JavaScript will populate this with the episode names -->
</datalist>

<script>
    const languageSelect = document.getElementById('language-select');
    const episodeNamesList = document.getElementById('episode-names');
    const noSeasonLabel = document.getElementById('no-season-label');
    const episodeGuessInput = document.getElementById('guess-input');
    const imageContainer = document.getElementById('image-container');
    const guessButton = document.getElementById('guess-button');
    const tryAgainButton = document.getElementById('try-again-button');
    const continueButton = document.getElementById('continue-button');
    const jokerButton = document.getElementById('joker-button');
    const feedbackText = document.getElementById('feedback');
    const livesLeftText = document.getElementById('lives-left');
    const scoreElement = document.getElementById('score');
    const highScoreElement = document.getElementById('high-score');
    const seasonSelect = $('#season-select');
    let imagesJsonData = {};
    let titlesJsonData = {};
    let seasonsJsonData = {};
    let keyedEpisodeNames = {};
    let allowedSeasonKeys = [];
    let allowedEpisodeKeyList = [];
    let episodeCount = 0;
    let previouslyShownEpisodes = [];
    let imagesShownDuringJoker = [];
    const startingJokers = 5;
    let jokerUsesLeft = startingJokers;
    const scoreToGetNewJoker = 30;
    const jokersToGet = 3;
    let fetchDone = false;
    let score = 0;
    const startingLives = 3;
    let livesLeft = startingLives;
    let currentEpisodeKey = "";
    let currentImageKey = "";

    $(document).ready(function () {
        $("#season-select").select2({
            multiple: true
        });
    });

    function updateJokerButton(usesLeft) {
        jokerButton.innerHTML = `
            <span style="vertical-align: middle;"><b>Joker</b></span>
            <span style="font-size: 0.7em; vertical-align: middle;"> (${usesLeft} left)</span>
        `;
    }

    tippy('#joker-button', {
        content: 'Show another image from the same episode',
        animation: 'shift-away-subtle',
    });

    livesLeftText.innerText = "Lives: " + livesLeft;
    updateJokerButton(jokerUsesLeft);
    checkHighScore();

    // First fetch the season keys from the season-keys JSON file
    fetch('season-keys.json')
        .then(response => response.json())
        .then(data => {
            seasonsJsonData = data;
            allowedSeasonKeys = Object.keys(seasonsJsonData);
            seasonSelect
                .empty() // Clear existing options
                .append(allowedSeasonKeys.map(seasonKey => new Option(seasonKey, seasonKey))) // Append new options
                .val(allowedSeasonKeys)
                .trigger('change')
                .select2({
                    closeOnSelect: false
                });

            // After that fetch the image list from the image-list JSON file
            return fetch('image-list.json');
        })
        .then(response => response.json())
        .then(data => {
            imagesJsonData = data;

            // After that fetch the language keys from the episode-titles JSON file and populate the language select
            return fetch('episode-titles.json');
        })
        .then(response => response.json())
        .then(data => {
            titlesJsonData = data;
            for (let language in data) {
                let option = document.createElement('option');
                option.value = language; // Set the value of the option
                option.textContent = language; // Set the text displayed in the option
                languageSelect.appendChild(option);
            }

            fetchDone = true;
            loadEpisodeNames();
            showRandomImage();
        });

    function loadEpisodeNames() {
        episodeGuessInput.value = "";

        allowedEpisodeKeyList = [];
        for (let seasonKey of allowedSeasonKeys) {
            allowedEpisodeKeyList = allowedEpisodeKeyList.concat(seasonsJsonData[seasonKey]);
        }
        episodeCount = allowedEpisodeKeyList.length;

        // Clear the episode names list
        episodeNamesList.innerHTML = "";

        // Fill the episode names list with the episode names from the episodes object
        keyedEpisodeNames = titlesJsonData[languageSelect.value];
        for (const episodeKey of allowedEpisodeKeyList) {
            let option = document.createElement('option');
            option.value = keyedEpisodeNames[episodeKey]; // Set the value of the option
            episodeNamesList.appendChild(option);
        }
    }

    // Add an event listener for when the language select changes
    languageSelect.addEventListener('change', (event) => {
        loadEpisodeNames(event.target.value);
    });

    seasonSelect.on('change', function () {
        allowedSeasonKeys = $(this).val();
        if (!fetchDone) return;

        if (allowedSeasonKeys.length === 0) {
            episodeGuessInput.style.display = 'none';
            guessButton.style.display = 'none';
            jokerButton.style.display = 'none';
            noSeasonLabel.style.display = 'block';
            return;
        } else {
            episodeGuessInput.style.display = 'block';
            guessButton.style.display = 'block';
            jokerButton.style.display = 'block';
            noSeasonLabel.style.display = 'none';
        }

        previouslyShownEpisodes = [];
        loadEpisodeNames(languageSelect.value);
        showRandomImage();
    });

    // Store the last 20% the episodes to prevent repeats and make it feel more random
    function addToLastEpisodeList(value) {
        // Only add 50% of the episodes to the list, so you don't know which episodes won't be repeated
        if (Math.random() > 0.5) return;

        // If the list is longer than 20% of the episode count, remove the first element
        if (previouslyShownEpisodes.length > episodeCount * 0.2) {
            previouslyShownEpisodes.shift();
        }
        previouslyShownEpisodes.push(value);
        console.log(previouslyShownEpisodes)
    }

    function getRandomEpisodeKey() {
        let randomEpisodeKey = allowedEpisodeKeyList[Math.floor(Math.random() * allowedEpisodeKeyList.length)];
        if (previouslyShownEpisodes.includes(randomEpisodeKey)) {
            return getRandomEpisodeKey();
        }

        addToLastEpisodeList(randomEpisodeKey);
        return randomEpisodeKey;
    }

    function getRandomImageKey(imageList) {
        return imageList[Math.floor(Math.random() * imageList.length)];
    }

    function showNewImage(encodedImage) {
        imageContainer.style.backgroundImage = 'url("' + encodedImage + '")';
        episodeGuessInput.value = "";
        feedbackText.innerText = '';
    }

    function showRandomImage() {
        currentEpisodeKey = getRandomEpisodeKey();

        const imageList = imagesJsonData[currentEpisodeKey];
        currentImageKey = getRandomImageKey(imageList);
        const encodedImage = encodeURI('randomframes/' + currentImageKey);

        showNewImage(encodedImage);
    }

    episodeGuessInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            checkGuess(episodeGuessInput.value);
        }
    });

    function handleJokerClick() {
        if (jokerUsesLeft > 0) {
            jokerUsesLeft--;
            updateJokerButton(jokerUsesLeft);
            imagesShownDuringJoker.push(currentImageKey);

            const imageList = imagesJsonData[currentEpisodeKey];
            if (imagesShownDuringJoker.length === imageList.length) imagesShownDuringJoker = [];

            // Prevent the same images to be shown twice during the same joker round
            while (imagesShownDuringJoker.includes(currentImageKey)) {
                currentImageKey = getRandomImageKey(imageList);
            }

            const encodedImage = encodeURI('randomframes/' + currentImageKey);
            showNewImage(encodedImage);
        } else {
            alert("You have no jokers left. You will get " + jokersToGet + " new jokers every " +
                scoreToGetNewJoker + " points.");
        }
    }

    function checkGuess(guess) {
        if (Object.values(keyedEpisodeNames).includes(guess)) {
            seasonSelect.prop('disabled', true);

            let currentEpisodeName = keyedEpisodeNames[currentEpisodeKey];
            if (guess === currentEpisodeName) {
                score++;
                showRandomImage();

                imagesShownDuringJoker = [];
                // If the score is a multiple of the scoreToGetNewJoker, give the player a new joker
                if (score % scoreToGetNewJoker === 0) {
                    jokerUsesLeft += jokersToGet;
                    updateJokerButton(jokerUsesLeft);
                }
            } else {
                episodeGuessInput.style.display = 'none';
                guessButton.style.display = 'none';
                jokerButton.style.display = 'none';
                livesLeft--;
                livesLeftText.innerText = "Lives: " + livesLeft;
                let episodeString = "You guessed " + guess + ", but the correct answer is " + currentEpisodeName + ".";
                if (livesLeft > 0) {
                    if (livesLeft === 1) {
                        feedbackText.innerHTML = episodeString + "<br><b>You have " + livesLeft + " life left</b>.";
                    } else {
                        feedbackText.innerHTML = episodeString + "<br><b>You have " + livesLeft + " lives left</b>.";
                    }
                    continueButton.style.display = 'block';
                } else {
                    tryAgainButton.style.display = 'block';
                    feedbackText.innerHTML = episodeString + "<br><b>Game over</b>.";
                }
            }
            scoreElement.innerText = "Score: " + score;
        } else {
            alert("Please select an episode from the list.");
        }

        checkHighScore();
    }

    function setHighScore(newScore, isHigher) {
        highScoreElement.innerText = 'High Score: ' + newScore;
        window.localStorage.setItem('high-score', newScore);

        if (isHigher) {
            highScoreElement.style.color = 'red';
        }
    }

    function checkHighScore() {
        const currentHighScore = Number(window.localStorage.getItem('high-score'));
        setHighScore(currentHighScore);

        if (!currentHighScore) {
            setHighScore(score)
        }
        if (score > currentHighScore) {
            setHighScore(score, true);
        }
    }

    function showGameButtons() {
        episodeGuessInput.style.display = 'block';
        guessButton.style.display = 'block';
        jokerButton.style.display = 'block';
        tryAgainButton.style.display = 'none';
        continueButton.style.display = 'none';
    }

    function resetGame() {
        score = 0;
        livesLeft = startingLives;
        livesLeftText.innerText = "Lives: " + livesLeft;

        showGameButtons()
        seasonSelect.prop('disabled', false);

        scoreElement.innerText = "Score: " + score;
        highScoreElement.style.color = "#000";
        jokerUsesLeft = startingJokers;
        updateJokerButton(jokerUsesLeft);

        showRandomImage();
    }

    function continueGame() {
        showGameButtons()

        showRandomImage();
    }

</script>
</body>
</html>
